@page
@model VolleyMatchAnalisis.Pages.VisualizzaDati.IndexModel
@{
    Layout = "_Layout";
}

<h2>Visualizza Dati</h2>

<form method="get" style="margin-bottom:20px;">
    <label>Codice Campionato:</label>
    <select name="FiltroCodice">
        <option value="">-- Tutti --</option>
        @foreach (var cod in Model.CodiciCampionato)
        {
            <option value="@cod" @(cod == Model.FiltroCodice ? "selected" : "")>@cod</option>
        }
    </select>

    <label>Squadra:</label>
    <select name="FiltroSquadra">
        <option value="">-- Tutte --</option>
        @foreach (var sq in Model.Squadre.Where(sq => sq != null))
        {
            <option value="@sq" @(sq == Model.FiltroSquadra ? "selected" : "")>@sq</option>
        }
    </select>

    <button type="submit">Esegui</button>
</form>

<hr />

@if (Model.GareFiltrate != null && Model.GareFiltrate.Any())
{
    <table id="gareTable" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Cod</th>
                <th>Data</th>
                <th>Ora</th>
                <th>Localit√†</th>
                <th>SquadraA</th>
                <th>SquadraB</th>
                <th>Ris</th>
                <th>Parziali</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var gara in Model.GareFiltrate)
            {
                var ris = gara.Ris?.Replace(" ", "").Trim();
                bool squadraAWin = ris == "3-0" || ris == "3-1" || ris == "3-2";
                bool squadraBWin = ris == "0-3" || ris == "1-3" || ris == "2-3";

                bool squadraSelezionataHaVinto =
                (!string.IsNullOrEmpty(Model.FiltroSquadra) && (
                (Model.FiltroSquadra == gara.SquadraA && squadraAWin) ||
                (Model.FiltroSquadra == gara.SquadraB && squadraBWin)
                ));

                bool squadraSelezionataHaPerso =
                (!string.IsNullOrEmpty(Model.FiltroSquadra) && (
                (Model.FiltroSquadra == gara.SquadraA && squadraBWin) ||
                (Model.FiltroSquadra == gara.SquadraB && squadraAWin)
                ));

                string classeRis = squadraSelezionataHaVinto ? "vittoria"
                : squadraSelezionataHaPerso ? "sconfitta"
                : "";

                <tr>
                    <td>@gara.Cod</td>
                    <td>@gara.Data.ToShortDateString()</td>
                    <td>@gara.Ora</td>
                    <td>@gara.Localita</td>
                    <td>@gara.SquadraA</td>
                    <td>@gara.SquadraB</td>
                    <td class="@classeRis">@gara.Ris</td>
                    <td>@gara.Parziali</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p><em>Nessuna gara trovata per i criteri selezionati.</em></p>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#gareTable').DataTable({
                paging: true,
                pageLength: 25,
                searching: true,
                ordering: true,
                order: [],  // Nessun ordinamento iniziale
                columnDefs: [
                    { orderable: false, targets: [6, 7] }  // Disabilita ordinamento su Ris e Parziali (se vuoi)
                ],
                language: {
                    search: "Cerca:",
                    lengthMenu: "Mostra _MENU_ elementi",
                    info: "Visualizzati da _START_ a _END_ di _TOTAL_ elementi",
                    infoEmpty: "Nessun elemento da visualizzare",
                    paginate: {
                        first: "Prima",
                        last: "Ultima",
                        next: "Successiva",
                        previous: "Precedente"
                    },
                }
            });
        });
    </script>
}